<!DOCTYPE html><html lang="en" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="google-site-verification" content="ADnLC0IeVgMa6OjbbqiE36ym_6ZmRiyEYXoege314pM" /><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴)" /><meta name="author" content="daru" /><meta property="og:locale" content="en_US" /><meta name="description" content="회사에서 많은 양의 API를 처리해야하는 서버를 구축해야하는 경우가 생겼습니다." /><meta property="og:description" content="회사에서 많은 양의 API를 처리해야하는 서버를 구축해야하는 경우가 생겼습니다." /><link rel="canonical" href="https://kimeuichan.github.io/posts/asnycio-with-blocing-task/" /><meta property="og:url" content="https://kimeuichan.github.io/posts/asnycio-with-blocing-task/" /><meta property="og:site_name" content="잡잡 블로그" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-11T00:45:00+09:00" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"daru"},"description":"회사에서 많은 양의 API를 처리해야하는 서버를 구축해야하는 경우가 생겼습니다.","mainEntityOfPage":{"@type":"WebPage","@id":"https://kimeuichan.github.io/posts/asnycio-with-blocing-task/"},"@type":"BlogPosting","url":"https://kimeuichan.github.io/posts/asnycio-with-blocing-task/","headline":"Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴)","dateModified":"2020-12-11T00:45:00+09:00","datePublished":"2020-12-11T00:45:00+09:00","@context":"https://schema.org"}</script><title>Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴) | 잡잡 블로그</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">잡잡 블로그</a></div><div class="site-subtitle font-italic">개발 및 잡다한 내용을 정리한 블로그입니다.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a href="https://github.com/kimeuichan" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['eck7965','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴)</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Dec 11, 2020, 12:45 AM +0900" > Dec 11, 2020 <i class="unloaded">2020-12-11T00:45:00+09:00</i> </span> by <span class="author"> daru </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Dec 11, 2020, 9:38 AM +0900" > Dec 11, 2020 <i class="unloaded">2020-12-11T09:38:37+09:00</i> </span></div></div><div class="post-content"><p>회사에서 많은 양의 API를 처리해야하는 서버를 구축해야하는 경우가 생겼습니다.</p><p>프로젝트 셋업에 있어 빠른 처리를 위해 <code class="language-plaintext highlighter-rouge">Sanic</code> 프레임워크를 사용하기로 했습니다.</p><p>다만, <a href="https://docs.celeryproject.org/en/stable/index.html"><code class="language-plaintext highlighter-rouge">celery</code></a>를 호출해야하는 경우가 생겨 <code class="language-plaintext highlighter-rouge">asyncio</code>와 호환성을 찾다가 결국 발견하지 못해 <code class="language-plaintext highlighter-rouge">asyncio</code>를 이용한 해결방안을 포스팅합니다.</p><p><strong>찾아본 방법</strong></p><ul><li><code class="language-plaintext highlighter-rouge">celery</code> 자체에서 <code class="language-plaintext highlighter-rouge">asyncio</code> <a href="https://stackoverflow.com/a/43325237/5944655">호환</a><ul><li>5 버전에서도 결국 지원을 하지 않는다.</ul><li><a href="https://github.com/kai3341/celery-pool-asyncio"><code class="language-plaintext highlighter-rouge">celery-pool-asyncio</code></a>를 사용<ul><li>작동은 하지만, redis를 이용한 result backend를 <a href="https://github.com/kai3341/celery-pool-asyncio/issues/30">지원하지 않아</a> 제외</ul></ul><h2 id="sanic이란">Sanic이란</h2><p><a href="https://sanic.readthedocs.io/en/latest/"><code class="language-plaintext highlighter-rouge">Sanic</code></a>은 파이썬 <code class="language-plaintext highlighter-rouge">asyncio</code>를 이용한 웹 프레임워크로 속도에 매우 초점을 맞춘 프레임 워크입니다.</p><p>비동기 기반으로 작동하며, <code class="language-plaintext highlighter-rouge">uvloop</code>를 사용할 수 있어 기본 파이선 <code class="language-plaintext highlighter-rouge">eventloop</code>를 활용한 것보다 좋은 성능을 끌어 낼 수 있습니다.</p><h3 id="sanic의-단점">Sanic의 단점</h3><p><code class="language-plaintext highlighter-rouge">asnycio</code>를 사용한 만큼 성능도 좋지만 단점이 여실히 들어나는 경우가 있는데 바로 <code class="language-plaintext highlighter-rouge">blocking</code> 함수를 호출한 경우 입니다.</p><p><code class="language-plaintext highlighter-rouge">asnycio</code>와 마찬가지로 <code class="language-plaintext highlighter-rouge">sanic</code>에서도 <code class="language-plaintext highlighter-rouge">blocing</code> 함수를 사용하면 해당 쓰레드가 멈추고(단일 쓰레드인 경우) 다른 응답을 처리하지 못하는 경우가 생깁니다.</p><p>따라서, 사용하는 함수가 모두 <code class="language-plaintext highlighter-rouge">non-blocking</code> 함수여야 성능에 도움이 단점이 있습니다.</p><blockquote><p>최근에는 <code class="language-plaintext highlighter-rouge">asyncio</code>를 이용한 라이브러리가 많았지만 몇 년전만 해도 그렇지 않았던 것으로 알고 있습니다. 최근 <a href="http://youngrok.com/asyncio%EC%97%90%20%EB%8C%80%ED%95%9C%20%ED%9A%8C%EC%9D%98">asyncio에 대한 회의 - 영록이 홈페이지</a>을 재밌게 읽었습니다.</p></blockquote><h2 id="해결법">해결법</h2><p>해결법은 <code class="language-plaintext highlighter-rouge">loop.run_in_executor</code> 함수를 사용해서 <code class="language-plaintext highlighter-rouge">awaitable</code> 객체를 만들어 해결하려 했습니다.</p><p>해당 방법을 증명하기 위해 실험을 시도했는데 그 중에서 나온 삽질 경험을 적어보았습니다.</p><h3 id="삽질">삽질</h3><p>다음과 같은 간단한 코드를 작성하여 테스트 해보려 했습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">concurrent.futures.thread</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">async_sleep</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"in async sleep task in </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sync_cpu_bound_task</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"in heavy cpu bound in </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">next_job</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"in coroutine task </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>

    <span class="k">await</span> <span class="n">_loop</span><span class="p">.</span><span class="n">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">sync_cpu_bound_task</span>
    <span class="p">)</span>

    <span class="k">await</span> <span class="n">next_job</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">async_sleep</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    
<span class="c1"># 예상 출력은 다음과 같았습니다.
# in coroutine task ~
# in async sleep task in ~
# in heavy cpu bound in ~
</span>
<span class="c1"># 실제 출력 값
# in heavy cpu bound in
# in coroutine task ~
# in async sleep task in ~
</span></pre></table></code></div></div><p>하지만 예상과는 다르게 첫번째 줄에서부터 바로 <code class="language-plaintext highlighter-rouge">blocking</code> 함수가 되버렸습니다.</p><p>Executor Pool 문제인가 싶어 <code class="language-plaintext highlighter-rouge">ProcessPool</code> 버전으로 재작성하였습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>

    <span class="k">await</span> <span class="n">_loop</span><span class="p">.</span><span class="n">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">sync_cpu_bound_task</span>
    <span class="p">)</span>

    <span class="k">await</span> <span class="n">next_job</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">async_sleep</span><span class="p">()</span>
    
<span class="c1">#in heavy cpu bound in 10503
#in coroutine task 10503
#in async sleep task in 10503
#elapsed time: 9.846224784851074
</span></pre></table></code></div></div><p>결과는 보기좋게 제 예상과 빗나갔습니다.</p><p>둘다 같이 <code class="language-plaintext highlighter-rouge">await</code>을 쓸 수 있는 오브젝트지만, 다른 방식으로 작동하는 것 같아 예전에 썻던 <a href="https://kimeuichan.github.io/posts/python-asyncio/">포스팅</a>을 다시 정독을 했습니다.</p><blockquote><p>asyncio의 핵심은 task(coroutine)를 관리이다.</p></blockquote><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">print</span><span class="p">(</span><span class="n">next_job</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">next_job</span><span class="p">()))</span>

<span class="c1">#&lt;coroutine object next_job at 0x10d7f6048&gt;
#&lt;Task pending coro=&lt;next_job() running at /Users/gim-uichan/study/python/async-sync-test.py:28&gt;&gt; in coroutine task 10360
</span></pre></table></code></div></div><p>결국 태스크로 등록이 되기전까지는 의미가 없다는걸 느끼게 되었습니다.</p><p>그래서 다음과 같이 다시 수정하여 테스트해보았고 의미있는 결과를 얻었습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>    <span class="n">t1</span> <span class="o">=</span> <span class="n">_loop</span><span class="p">.</span><span class="n">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">sync_cpu_bound_task</span>
    <span class="p">)</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">next_job</span><span class="p">())</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">async_sleep</span><span class="p">())</span>

    <span class="k">await</span> <span class="n">t1</span>
    <span class="k">await</span> <span class="n">t2</span>
    <span class="k">await</span> <span class="n">t3</span>
    
<span class="c1">#in coroutine task 10501
#in async sleep task in 10501
#in heavy cpu bound in 10501
#elapsed time: 9.368857145309448
</span></pre></table></code></div></div><p>보시는 바와 같이 실행 순서가 예상에 출력되었습니다.</p><h2 id="task-coroutine">Task? Coroutine?</h2><p><code class="language-plaintext highlighter-rouge">Task</code>과 <code class="language-plaintext highlighter-rouge">Coroutine</code>은 뭐가 다르기에 다르게 동작하는지 궁금해졌습니다.</p><h3 id="coroutine"><a href="https://docs.python.org/ko/3/library/asyncio-task.html#coroutines">Coroutine</a></h3><p>공식문서에 아주 중요한 문구가 문구가 있습니다.</p><p><strong>코루틴을 기다리기. 다음 코드 조각은 1초를 기다린 후 《hello》를 인쇄한 다음 또 2초를 기다린 후 《world》를 인쇄합니다.</strong></p><p>실제로 코루틴을 <code class="language-plaintext highlighter-rouge">await</code> 한다고 해서 무조건 비동기적으로 코드가 실행되는 것이 아닙니다.</p><p>태스크로 등록이 되어야지만 비동기로 실행이 가능해집니다.</p><h3 id="task"><a href="https://docs.python.org/ko/3/library/asyncio-task.html#task-object">Task</a></h3><p><code class="language-plaintext highlighter-rouge">Task</code>는 <code class="language-plaintext highlighter-rouge">Future</code>의 한 종류로, 이벤트 루프에서 코루틴을 실행하는데 사용합니다.</p><p>만약 코루틴이 <code class="language-plaintext highlighter-rouge">Future</code>를 기다리고 있다면, 태스크는 코루틴의 실행을 일시 중지하고 <code class="language-plaintext highlighter-rouge">Future</code>의 완료를 기다립니다. 그동안 이벤트 루프는 다른 태스크, 콜백을 실행하거나 IO 연산을 수행합니다.(협업 스케줄링)</p><p><code class="language-plaintext highlighter-rouge">Future</code>가 완료되면, 감싸진 코루틴의 실행이 다시 시작됩니다.</p><p><strong>이벤트 루프는 한 번에 하나의 <code class="language-plaintext highlighter-rouge">Task</code>를 실행합니다.</strong></p><h3 id="futrue"><a href="https://docs.python.org/ko/3/library/asyncio-future.html#asyncio.Future">Futrue</a></h3><p>Future는 비동기 연산의 최종 결과를 나타냅니다.</p><p>Future는 어웨이터블 객체입니다. 코루틴은 결과나 예외가 설정되거나 취소될 때까지 <code class="language-plaintext highlighter-rouge">Future</code> 객체를 기다릴 수 있습니다.</p><p>일반적으로 퓨처는 저수준 콜백 기반 코드(예를 들어, <code class="language-plaintext highlighter-rouge">asyncio</code> 트랜스포트를 사용하여 구현된 프로토콜에서)가 고수준 <code class="language-plaintext highlighter-rouge">async/await </code>코드와 상호 운용되도록 하는 데 사용됩니다.</p><blockquote><p>어웨이터블 객체란(Awaitable) <code class="language-plaintext highlighter-rouge">await</code> 표현식을 사용할 수 있는 객체로 <code class="language-plaintext highlighter-rouge">__await__</code> 메서드를 가진 객체나, 코루틴 등이 있습니다.</p></blockquote><h3 id="정리">정리</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/task-coroutine-future.png" alt="task-future-coroutine.png" /></p><blockquote><p>해당 정리는 제가 그린 그림임으로 틀릴 수 있습니다. 잘못된 부분은 메일로 보내주시면 바로 수정하겠습니다.</p></blockquote><h4 id="번외">번외</h4><p><strong>문득 cpu-bound task를 멀티프로세스로 실행시키면 어떻게 될지 궁금해졌습니다.</strong></p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">_loop</span><span class="p">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="n">pool</span><span class="p">,</span>
            <span class="n">sync_cpu_bound_task</span>
        <span class="p">)</span>

        <span class="n">t2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">next_job</span><span class="p">())</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">async_sleep</span><span class="p">())</span>

        <span class="k">await</span> <span class="n">t1</span>
        <span class="k">await</span> <span class="n">t2</span>
        <span class="k">await</span> <span class="n">t3</span>
        
<span class="c1">#in coroutine task 11067
#in async sleep task in 11067
#in heavy cpu bound in 11068
#elapsed time: 10.087301969528198
</span></pre></table></code></div></div><p>cpu-bound task에 process context swicthing 때문인지 크게 다른점은 없었습니다.</p><p>다른점은 <code class="language-plaintext highlighter-rouge">os.getpid()</code>를 통해 확인할수 있듯이 다른 process로 돌아간다는 점이였습니다.</p><p><strong><code class="language-plaintext highlighter-rouge">Sanic</code>에서 <code class="language-plaintext highlighter-rouge">Task</code>을 사용한 방법과 코루틴을 이용한 방법에 성능적 차이가 있을지 궁금했졌습니다.</strong></p><blockquote><p>테스트 환경</p><p>Macbook pro 2018 15 inch</p><p>2.6 GHz 6코어 Intel Core i7</p><p>16GB 2400 MHz DDR4</p><p>Mojave Python 3.7</p><p>Jmeter</p></blockquote><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">from</span> <span class="nn">sanic</span> <span class="kn">import</span> <span class="n">Sanic</span>
<span class="kn">from</span> <span class="nn">sanic.response</span> <span class="kn">import</span> <span class="n">text</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Sanic</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">sleep_task</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/coroutine"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">coroutine</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">sleep_task</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">)</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/task"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">sleep_task</span><span class="p">())</span>
    <span class="k">await</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">)</span>


<span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="s">"0.0.0.0"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</pre></table></code></div></div><p><strong>sleep 함수</strong> 결과</p><p><em>코루틴 결과</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-sleep-coroutine.png" alt="sanic-sleep-coroutine.png" /></p><p><em>태스크 결과</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-sleep-task.png" alt="sanic-sleep-task.png" /></p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">from</span> <span class="nn">aiohttp</span> <span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span> <span class="nn">sanic</span> <span class="kn">import</span> <span class="n">Sanic</span>
<span class="kn">from</span> <span class="nn">sanic.response</span> <span class="kn">import</span> <span class="n">text</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Sanic</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">sleep_task</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">network_task</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://wtfismyip.com/json"</span><span class="p">)</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/coroutine"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">coroutine</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">network_task</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">)</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/task"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">network_task</span><span class="p">())</span>
    <span class="k">await</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">)</span>


<span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="s">"0.0.0.0"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</pre></table></code></div></div><p><strong>aiohttp GET</strong> 결과</p><p><em>코루틴 결과</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-http-coroutine.png" alt="sanic-http-coroutine.png" /></p><p><em>태스크 결과</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-http-task.png" alt="sanic-http-task.png" /></p><h2 id="celery와-같이-쓰기">Celery와 같이 쓰기</h2><p>이제 해당 포스팅의 주제인 <code class="language-plaintext highlighter-rouge">celery</code>와 같이 써보겠습니다.</p><p><code class="language-plaintext highlighter-rouge">celery</code>의 설정 별로 물론 결과가 달라질 수 있으나 일반적으로 많이 쓰는 <code class="language-plaintext highlighter-rouge">rabbitmq</code> <strong>브로커</strong>와 <code class="language-plaintext highlighter-rouge">redis</code> <strong>result backend</strong>를 사용했습니다.</p><p><code class="language-plaintext highlighter-rouge">worker</code>에서는 간단하지만 cpu-bound인 팩토리얼을 돌려봤습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>


<span class="n">celery_task</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s">"amqp://guest:guest@localhost:5672"</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s">"redis://localhost:6379/0"</span><span class="p">)</span>


<span class="o">@</span><span class="n">celery_task</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">heavy_task</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">math</span><span class="p">.</span><span class="n">factorial</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></table></code></div></div><p>jmeter를 통해 100 threads X 5번 을 실행하여 결과를 내보았습니다.</p><h3 id="executor에서-실행하기">Executor에서 실행하기</h3><p>파이썬 asyncio 중 <a href="https://docs.python.org/ko/3/library/asyncio-eventloop.html#asyncio.loop.run_in_executor"><code class="language-plaintext highlighter-rouge">loop.run_in_executor(pool, func)</code></a>라는 함수가 있습니다.</p><p>해당 함수는 <code class="language-plaintext highlighter-rouge">blocing</code> 함수를 <code class="language-plaintext highlighter-rouge">awaitable</code>하게 돌릴 수 있도록 task로 만들어주는 함수입니다.</p><p>또한, 어느 <code class="language-plaintext highlighter-rouge">pool</code>에서 돌릴건지도 설정이 가능하며 loop내의 기본 executor 또는 thread executor, process executor 등을 지원합니다.</p><p>해당 함수를 이용해서 코드는 다음과 같습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/task"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">celery_result</span> <span class="o">=</span> <span class="n">heavy_task</span><span class="p">.</span><span class="n">delay</span><span class="p">()</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">loop</span><span class="p">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">celery_result</span><span class="p">.</span><span class="n">get</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s">"hello world: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><p>하지만, 해당 기본 executor나 thread pool, process pool에서 돌려도 동작하지 않았습니다.</p><p>대부분 <code class="language-plaintext highlighter-rouge">run_in_executor</code> 내부에서 어떠한 로직때문인지는 모르겠지만 <code class="language-plaintext highlighter-rouge">celery</code> 내부 동작 코드가 작동하지 않았습니다.</p><p>아래와 같은 exception이 발생하며 출력되며 에러율은 16%로 기록되었습니다.</p><ul><li><code class="language-plaintext highlighter-rouge">redis.exceptions.InvalidResponse: Protocol Error: b'date_done": "2020-12-10T14:29:20.335394", "task_id": "41614cdf-5b70-443a-915f-6f0cb9683fd7"}'</code><li><code class="language-plaintext highlighter-rouge">redis.exceptions.InvalidResponse: Protocol Error: b'CCESS", "result": 2432902008176640000, "traceback": null, "children": [], "date_done": "2020-12-10T14:29:16.887731", "task_id": "d6c483af-611e-468e-8fb2-036c6d5ee0bf"}'</code><li><code class="language-plaintext highlighter-rouge">redis.exceptions.InvalidResponse: Protocol Error: b'\x00\x00...\x00\x00*3'</code></ul><p>문제는 exception만 발생한게 아니라 서버가 멈춰버리는 경우가 있어 500번의 요청을 모두 처리하지 못했습니다.</p><p>기다리면 처리 갯수는 올라갔으나, 의미가 없다고 판단해 모두 스톱하였습니다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-celery-run-in-executor.png" alt="sanic-celery-run-in-executor.png" /></p><h3 id="awaitable을-이용해-돌리기"><code class="language-plaintext highlighter-rouge">awaitable</code>을 이용해 돌리기</h3><p>효율이 가장 좋을거라고 판단했던 <code class="language-plaintext highlighter-rouge">run_in_executor</code>를 쓰지 못하게 되어, 꿩 대신 닭이라고</p><p>코루틴을 이용해서 처리라도 해보자라는 생각이 들어 코루틴으로 작성하였습니다.</p><p><strong>Coroutine</strong></p><p>가장 기본적인 코루틴을 이용하도록 다음과 같이 작성해서 테스트 해보았습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/coroutine"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">coroutine</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">celery_result</span> <span class="o">=</span> <span class="n">heavy_task</span><span class="p">.</span><span class="n">delay</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_celery_await</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">celery_result</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>

    <span class="n">celery_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_celery_await</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s">"hello world: </span><span class="si">{</span><span class="n">celery_result</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><p>결과는 다음과 같습니다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-celery-coroutine-fast.png" alt="sanic-celery-coroutine-fast.png" /></p><p>신기하게도 아주 가끔 블록킹 되듯이 서버가 느려지는 경우가 있는 것을 확인했습니다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-celery-coroutine-slow.png" alt="sanic-celery-coroutine-slow.png" /></p><p><strong>Task</strong></p><p>위의 코루틴 예제를 이용하여 태스크를 만들고 실행하도록 작성하였습니다.</p><p>태스크를 만드는데 간단한 몇가지 방법이 있는데 제가 사용한 방법은 아래 두가지입니다.</p><ul><li><code class="language-plaintext highlighter-rouge">wait_for</code><li><code class="language-plaintext highlighter-rouge">create_task</code></ul><p><strong>wait_for</strong> 버전</p><p><a href="https://docs.python.org/ko/3/library/asyncio-task.html#asyncio.wait_for"><code class="language-plaintext highlighter-rouge">wait_for(aw, timeout, *, loop=None)</code></a>의 함수의 경우 공식홈페이지에 다음과 같이 적혀있습니다.</p><blockquote><p>aw가 코루틴이면 자동으로 태스크로 예약됩니다.</p></blockquote><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/task"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">celery_result</span> <span class="o">=</span> <span class="n">heavy_task</span><span class="p">.</span><span class="n">delay</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">celery_result</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">test</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s">"hello world: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><p>막상 돌려보니 코루틴 버전과 크게 퍼포먼스 차이가 나지않았습니다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-celery-wait-for.png" alt="sanic-celery-wait-for.png" /></p><p>왜 이러한 결과가 나타났는지 알아보기위해 <code class="language-plaintext highlighter-rouge">wait_for</code> 함수를 찾아보았습니다. 그리고 아래와 같은 코드를 발견하였습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">wait_for</code>을 호출해 태스크를 만들 때는 <code class="language-plaintext highlighter-rouge">timeout</code> 파라미터를 주어야지만 태스크로 동작한다는 것을 알게되었습니다.</p><p>다음과 같이 소스코드를 수정한 후 다시 테스트 해보았습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/task"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">celery_result</span> <span class="o">=</span> <span class="n">heavy_task</span><span class="p">.</span><span class="n">delay</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">celery_result</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">test</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s">"hello world: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><p>일반 코루틴 보다 빠른 속도를 확인 할 수 있었습니다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-celery-wait-for-update.png" alt="sanic-celery-wait-for-update.png" /></p><p><strong>create_task</strong> 버전</p><p><a href="https://docs.python.org/ko/3/library/asyncio-task.html#asyncio.create_task"><code class="language-plaintext highlighter-rouge">create_task(coro, *, name=None)</code></a>는 가장 간단하게 태스크를 만들 수 있는 간단한 함수입니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/task"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">celery_result</span> <span class="o">=</span> <span class="n">heavy_task</span><span class="p">.</span><span class="n">delay</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">celery_result</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">test</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s">"hello world: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">wait_for</code> 함수보다 조금 더 좋은 속도가 나왔습니다.</p><blockquote><p>아마 로직이 조금 덜 타기 때문이지 않을까라고 예상하고있습니다.</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-celery-create-task.png" alt="sanic-celery-create-task.png" /></p><p><strong>Non-blocking</strong></p><p>논외로 그냥 일반 함수로 실행하면 어떻게 될지 궁금하여 실행해보았습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/blocking"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">blocking</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">celery_result</span> <span class="o">=</span> <span class="n">heavy_task</span><span class="p">.</span><span class="n">delay</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">celery_result</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s">"hello world: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><p>코루틴 버전과 거의 동일한 속도가 나오는 것을 확인할 수 있엇습니다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/posts/asnycio-with-blocing-task/sanic-celery-blocking.png" alt="sanic-celery-blocking.png" /></p><blockquote><p>제일 빠를 거라고 예상했던 <code class="language-plaintext highlighter-rouge">loop.run_in_executor</code> 함수가 동작하지 않아 매우 아쉬웠습니다. result backed 따라 다른가 싶어 <code class="language-plaintext highlighter-rouge">redis</code>, <code class="language-plaintext highlighter-rouge">rpc</code> 두 가지 모두 테스트하였으나 모두 동작하지 않았습니다. <code class="language-plaintext highlighter-rouge">redis</code> 보다 <code class="language-plaintext highlighter-rouge">rpc</code>가 조금 속도면에서 우세하였으나 많은 요청량에서 에러율이 올라가는 상황이 있었습니다. <code class="language-plaintext highlighter-rouge">loop.run_in_executor</code>가 돌지 않는 이유와 <code class="language-plaintext highlighter-rouge">rpc</code>에서 많은 요청은 에러율이 올라가는지는 나중에 다뤄보도록 하겠습니다.</p></blockquote><h2 id="결론">결론</h2><p>웹 서버 등(IO 작업이 많은 앱)에서 <code class="language-plaintext highlighter-rouge">blocking</code> 함수를 실행하고 싶은 경우에는 <code class="language-plaintext highlighter-rouge">run_in_executor</code>나 <code class="language-plaintext highlighter-rouge">create_task</code> 함수를 통해</p><p>최소한이라도 태스크 객체를 만들어 돌리는 것이 일반 <code class="language-plaintext highlighter-rouge">Non-blocking</code> 함수를 사용하는 것보다 효율이 좋다.</p><h4 id="참고-자료">참고 자료</h4><ul><li><a href="https://docs.python.org/ko/3/library/asyncio-task.html">코루틴과 태스크 — Python 3.9.1rc1 문서</a><li><a href="https://docs.python.org/ko/3/glossary.html#term-awaitable">용어집 — Python 3.9.1rc1 문서</a><li><a href="https://stackoverflow.com/a/55766474/5944655">python - What is the overhead of an asyncio task? - Stack Overflow</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>programming</a>, <a href='/categories/python/'>python</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/concurrency/" class="post-tag no-text-decoration" >concurrency</a> <a href="/tags/asyncio/" class="post-tag no-text-decoration" >asyncio</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴) - 잡잡 블로그&url=https://kimeuichan.github.io/posts/asnycio-with-blocing-task/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴) - 잡잡 블로그&u=https://kimeuichan.github.io/posts/asnycio-with-blocing-task/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴) - 잡잡 블로그&url=https://kimeuichan.github.io/posts/asnycio-with-blocing-task/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/deploy-docker-more-faster/">자주 변경되는 도커 이미지 빠르게 배포하기 (feat. 이미지 사이즈)</a><li><a href="/posts/python-asyncio/">Python에서 asyncio의 동작</a><li><a href="/posts/python-logging-with-loguru/">loguru를 사용하여 python 로깅 쉽게하기</a><li><a href="/posts/asnycio-with-blocing-task/">Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/asyncio/">asyncio</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/async/">async</a> <a class="post-tag" href="/tags/celery/">celery</a> <a class="post-tag" href="/tags/parallel/">parallel</a> <a class="post-tag" href="/tags/rabbitmq/">rabbitmq</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/python-asyncio/"><div class="card-body"> <span class="timeago small" > Nov 9, 2020 <i class="unloaded">2020-11-09T06:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python에서 asyncio의 동작</h3><div class="text-muted small"><p> python - How does asyncio actually work? - Stack Overflow 해당글을 번역한 글입니다. 파이썬에서 asnyc는 coroutine을 기반으로 동작합니다. coroutine의 동작을 이해하기 전 generator의 개념을 알고가면 이해하기 쉽기 때문에 먼저 generator 개념 부터 설명하겠습니다. Gen...</p></div></div></a></div><div class="card"> <a href="/posts/python-gil/"><div class="card-body"> <span class="timeago small" > Nov 20, 2020 <i class="unloaded">2020-11-20T06:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python의 GIL</h3><div class="text-muted small"><p> 해당글은 What Is the Python Global Interpreter Lock (GIL)? – Real Python을 번역 및 정리한 포스팅입니다. GIL이란 Global Interpreter Lock의 약자입니다. 한 쓰레드만을 사용해 파이썬 인터프리터를 제어하게 하는 mutex(or lock) 입니다. 어느 시점에서든 하나의 스레드 만 ...</p></div></div></a></div><div class="card"> <a href="/posts/python-celery/"><div class="card-body"> <span class="timeago small" > Nov 15, 2020 <i class="unloaded">2020-11-15T06:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python Celery란</h3><div class="text-muted small"><p> 해당 글은 celery를 이용하여 코드를 잘 작성하는것에 비중을 둔 글이 아니라 간단한 celery 소개 및 특징과 broker에 대해 공부하기 위해 작성한 글입니다. Celery는 python 동시성 프로그래밍에서 가장 많이 사용되는 방법 중 하나입니다. 몇 가지 설정만 한다면 간단하게 python 코드를 실행하는 worker를 만들 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/python-interpreter/" class="btn btn-outline-primary"><p>Python Interpreter</p></a> <a href="/posts/python-logging-with-loguru/" class="btn btn-outline-primary"><p>loguru를 사용하여 python 로깅 쉽게하기</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/kimeuichan">Euichan Kim</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/asyncio/">asyncio</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/async/">async</a> <a class="post-tag" href="/tags/celery/">celery</a> <a class="post-tag" href="/tags/parallel/">parallel</a> <a class="post-tag" href="/tags/rabbitmq/">rabbitmq</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://kimeuichan.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); </script>
