<!DOCTYPE html><html lang="en" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="google-site-verification" content="ADnLC0IeVgMa6OjbbqiE36ym_6ZmRiyEYXoege314pM" /><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Python의 GIL" /><meta name="author" content="daru" /><meta property="og:locale" content="en_US" /><meta name="description" content="해당글은 What Is the Python Global Interpreter Lock (GIL)? – Real Python을 번역 및 정리한 포스팅입니다." /><meta property="og:description" content="해당글은 What Is the Python Global Interpreter Lock (GIL)? – Real Python을 번역 및 정리한 포스팅입니다." /><link rel="canonical" href="https://kimeuichan.github.io/posts/python-gil/" /><meta property="og:url" content="https://kimeuichan.github.io/posts/python-gil/" /><meta property="og:site_name" content="잡잡 블로그" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-20T06:00:00+09:00" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"daru"},"description":"해당글은 What Is the Python Global Interpreter Lock (GIL)? – Real Python을 번역 및 정리한 포스팅입니다.","mainEntityOfPage":{"@type":"WebPage","@id":"https://kimeuichan.github.io/posts/python-gil/"},"@type":"BlogPosting","url":"https://kimeuichan.github.io/posts/python-gil/","headline":"Python의 GIL","dateModified":"2020-11-20T06:00:00+09:00","datePublished":"2020-11-20T06:00:00+09:00","@context":"https://schema.org"}</script><title>Python의 GIL | 잡잡 블로그</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">잡잡 블로그</a></div><div class="site-subtitle font-italic">개발 및 잡다한 내용을 정리한 블로그입니다.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a href="https://github.com/kimeuichan" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['eck7965','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Python의 GIL</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Python의 GIL</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Nov 20, 2020, 6:00 AM +0900" > Nov 20, 2020 <i class="unloaded">2020-11-20T06:00:00+09:00</i> </span> by <span class="author"> daru </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Nov 19, 2020, 9:38 PM +0900" > Nov 19, 2020 <i class="unloaded">2020-11-19T21:38:21+09:00</i> </span></div></div><div class="post-content"><p>해당글은 <a href="https://realpython.com/python-gil/">What Is the Python Global Interpreter Lock (GIL)? – Real Python</a>을 번역 및 정리한 포스팅입니다.</p><h2 id="gil이란">GIL이란</h2><p>Global Interpreter Lock의 약자입니다. 한 쓰레드만을 사용해 파이썬 인터프리터를 제어하게 하는 <code class="language-plaintext highlighter-rouge">mutex</code>(or <code class="language-plaintext highlighter-rouge">lock</code>) 입니다.</p><p>어느 시점에서든 하나의 스레드 만 실행 상태에있을 수 있습니다. GIL의 영향은 단일 스레드 프로그램을 실행하는 개발자에게 보이지 않지만 CPU 바인딩 및 다중 스레드 코드에서 성능 병목 현상이 될 수 있습니다.</p><p>GIL은 하나 이상의 CPU 코어가있는 다중 스레드 아키텍처에서도 한 번에 하나의 스레드 만 실행할 수 있도록 허용해 많은 파이썬 앱에 성능 이슈를 끼칩니다.</p><h2 id="왜-gil이-생겼을까">왜 GIL이 생겼을까</h2><p><strong>Python은 메모리 관리를 위해 변수(container object)의 참조 횟수를 계산을 사용합니다.</strong></p><p>즉, 파이썬에서 생성 된 객체에는 객체를 가리키는 참조 수를 카운팅하는 참조 변수가 있습니다. 이 카운트가 0에 도달하게 되면 객체가 메모리에서 해제됩니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">sys</span>


<span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span>

<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="c1"># 3
</span><span class="k">del</span> <span class="n">b</span>

<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="c1"># 2
</span></pre></table></code></div></div><p>위의 예제에서 빈 리스트 객체<code class="language-plaintext highlighter-rouge">[]</code>의 참조 횟수는 <code class="language-plaintext highlighter-rouge">a, b, sys.getrefcount()</code> 인수에서 사용하기 때문에 때문에 3입니다.</p><p>문제는 참조 카운트 변수를 두 쓰레드가 동시에 값을 늘리거나 줄이는 경쟁 조건으로부터 보호해야한다는 것입니다. 이런 일이 발생하면 메모리 릭 또는 해당 객체에 참조하는 동안 메모리에서 사라질 수 있습니다.</p><p>해당문제를 해결하고자 <code class="language-plaintext highlighter-rouge">Lock</code>을 추가할 경우 각 개체 또는 개체 그룹에 잠금을 추가하면 교착 상태를 유발할 수 있습니다. 또한 모든 변수에 <code class="language-plaintext highlighter-rouge">Lock</code> 만들어야 함으로 반복적인 잠금 및 해제 때문에 성능 저하 일으킬 수 있습니다.</p><p>이러한 문제를 해결하고자 Python은 인터프리터 자체에 대한 단일 잠금으로 Python 바이트 코드를 실행하려면 인터프리터 잠금(GIL)을 획득해야한다는 규칙을 추가했습니다. GIL은 교착 상태를 방지하고 (잠금이 하나뿐이므로) 성능 오버 헤드를 많이 발생시키지 않습니다. 하지만 모든 CPU 바인딩 Python 프로그램을 단일 스레드로 만들었습니다.</p><h2 id="왜-gil을-사용하는가">왜 GIL을 사용하는가</h2><p><code class="language-plaintext highlighter-rouge">Python</code>은 운영 체제에 쓰레드 개념이 없었던 시절부터 사용되었습니다. <code class="language-plaintext highlighter-rouge">Python</code>은 개발 속도를 높이기 위해 사용하기 쉽게 설계되었으며 점점 더 많은 개발자가 사용하기 시작했습니다.</p><ul><li>Python에 기존 C extension을 추가하기 쉬워졌습니다.<li>Process context swtiching의 overhead가 사라져 단일 스레드 프로그램의 성능이 향상되었습니다.<li>쓰레드로부터 안전하지 않은 C 라이브러리는 통합하기가 더 쉬워졌습니다.</ul><h2 id="멀티-쓰레드를-사용하는-python-프로그램에-미치는-영향">멀티 쓰레드를 사용하는 Python 프로그램에 미치는 영향</h2><p>일반적인 Python 프로그램을 살펴보면 성능면에서 CPU 바인딩 된 프로그램과 <code class="language-plaintext highlighter-rouge">I/O</code> 바인딩 된 프로그램간에 차이가 있습니다.</p><p>CPU 바운드 프로그램은 CPU를 한계까지 밀어 붙이는 프로그램입니다. 행렬 곱셈, 검색, 이미지 처리 등과 같은 수학적 계산을 수행하는 프로그램이 포함됩니다.</p><p><code class="language-plaintext highlighter-rouge">I/O</code> 바인딩 된 프로그램은 사용자, 파일, 데이터베이스, 네트워크 등에서 올 수있는 <code class="language-plaintext highlighter-rouge">I/O</code>을 기다리는 데 시간을 소비하는 프로그램입니다. <code class="language-plaintext highlighter-rouge">I/O</code> 바인딩 된 프로그램은 CPU를 사용은 하지 않지만 프로그램 실행을 기다립니다. 예를 들어 사용자가 입력 프롬프트에 입력 할 내용을 생각하거나 데이터베이스 쿼리가 프로세스가 대표적입니다.</p><p>카운트 다운을 수행하는 간단한 CPU 바인딩 프로그램을 살펴 보겠습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">time</span>

<span class="n">COUNT</span> <span class="o">=</span> <span class="mi">50000000</span>


<span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>


<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">countdown</span><span class="p">(</span><span class="n">COUNT</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Time taken in seconds -'</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<span class="c1"># Time taken in seconds - 2.2837860584259033
</span></pre></table></code></div></div><p>이제 두 개의 스레드를 병렬로 사용하도록 코드를 수정 후 실행하면 다음과 같습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="n">COUNT</span> <span class="o">=</span> <span class="mi">50000000</span>


<span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>


<span class="n">t1</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">COUNT</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,))</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">COUNT</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,))</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
<span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Time taken in seconds -'</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<span class="c1"># Time taken in seconds - 2.226407051086426
</span></pre></table></code></div></div><p>보시다시피 완료하는 데 거의 같은 시간이 걸립니다. 멀티 쓰레드 코드에서 GIL은 CPU 바운드 스레드가 병렬로 실행되는 것을 막습니다.</p><p><strong>GIL은 <code class="language-plaintext highlighter-rouge">I/O</code>를 기다리는 동안 스레드간에 잠금이 해제되기 때문에 <code class="language-plaintext highlighter-rouge">I/O</code> 바인딩 된 다중 스레드 프로그램의 성능에 큰 영향을주지 않습니다.</strong></p><blockquote><p><a href="https://stackoverflow.com/a/29270846/5944655">multithreading - Why is a Python I/O bound task not blocked by the GIL? - Stack Overflow</a> <a href="https://docs.python.org/3/c-api/init.html#thread-state-and-the-global-interpreter-lock">Initialization, Finalization, and Threads — Python 3.9.0 documentation</a></p></blockquote><p>그러나 쓰레드가 전체적으로 CPU 바운드인 프로그램 (쓰레드를 사용하여 이미지를 부분적으로 처리하는 프로그램)은 잠금으로 인해 단일 스레드가 될뿐만 아니라 실행 시간도 증가합니다.</p><p>이 증가는 잠금에 의해 추가 된 오버 헤드 획득 및 해제의 결과입니다.</p><h4 id="번외">번외</h4><p>multi proccess, 4개의 쓰레드를 사용한 코드를 작성해 비교해보았습니다.(밑에 내용에 이미 포함되어 있엇네요.)</p><p><strong>multi process</strong></p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="n">COUNT</span> <span class="o">=</span> <span class="mi">50000000</span>


<span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>


<span class="n">t1</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">COUNT</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,))</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">COUNT</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,))</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
<span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Time taken in seconds -'</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<span class="c1"># Time taken in seconds - 1.1550788879394531
</span></pre></table></code></div></div><p><strong>Nth thread</strong> macos Mojave Python 3.7 기준으로 흥미로운 결과가 나왔습니다. 4 쓰레드보단 1쓰레드가 빠르지만 1 쓰레드는 2 쓰레드보다 느리게 나왔습니다.</p><p><em>1 thread</em> 2.202889919281006 2.2208809852600098 2.2509100437164307 2.1846389770507812 2.2133240699768066</p><p>avg: 2.214528799</p><p><em>2 thread</em> 2.1756350994110107 2.184033155441284 2.1663358211517334 2.2320470809936523 2.2731218338012695</p><p>avg: 2.206234598</p><p><em>4 thread</em> 2.1956586837768555 2.218824863433838 2.3495471477508545 2.388563871383667 2.186440944671631</p><p>avg: 2.267807102</p><blockquote><p>구글링을 해봐도 구글링 실력이 부족한 탓인지 <a href="https://stackoverflow.com/questions/64911551/python-single-thread-is-slower-than-two-thread-in-cpu-bound">stackoverflow에 질문을 남겼습니다</a>….</p></blockquote><h2 id="gil이-아직까지-남아있는-이유">GIL이 아직까지 남아있는 이유</h2><p><code class="language-plaintext highlighter-rouge">Python</code> 개발자는 이에 대해 많은 불만을 받고 있지만 <code class="language-plaintext highlighter-rouge">Python</code>만큼 인기있는 언어는 이전 버전의 비 호환성 문제를 일으키지 않고 GIL 제거만큼 중요한 변화를 가져올 수 없습니다.</p><p>GIL은 분명히 제거 될 수 있으며 이는 과거에 개발자와 연구원에 의해 여러 번 수행되었지만 이러한 시도는 GIL이 제공하는 솔루션에 크게 의존하는 기존 C extension을 손상 시켰습니다.</p><p>물론 GIL이 해결하는 문제에 대한 다른 솔루션이 있지만 그중 일부는 단일 스레드 및 다중 스레드 <code class="language-plaintext highlighter-rouge">I/O</code> 바인딩 프로그램의 성능을 저하시키거나 어려웠습니다.</p><h2 id="python-3에서-제거되지-않은-이유는">Python 3에서 제거되지 않은 이유는?</h2><p>Python 3은 처음부터 많은 기능을 시작할 수있는 기회를 가졌고 그 과정에서 기존 C extension 중 일부를 깨뜨려 Python 3에서 작동하도록 업데이트 및 이식했습니다. 그러나 안정성이 뛰어나지 않아 초기 버전의은 커뮤니티에서 채택 속도가 느렸습니다.</p><h3 id="그럼에도-gil이-함께-제거되지-않은-이유는">그럼에도 GIL이 함께 제거되지 않은 이유는?</h3><p>GIL을 제거하면 단일 스레드 성능에서 Python2에 비해 Python3이 느려질 수 있으며 그 결과로 어떤 결과가 나올지 상상할 수 있습니다. GIL의 단일 스레드 성능 이점에 대해 논쟁 할 수 없고, GIL을 제거하지 않았습니다.</p><h4 id="python-멀티-쓰레드를-사용하는데-가장-큰-문제점-및-개선책">Python 멀티 쓰레드를 사용하는데 가장 큰 문제점 및 개선책</h4><p>CPU 바운드 쓰레드에서 GIL을 I/O 바운드 스레드가 얻을 수 있는 기회를주지 않음으로써 고갈시키는 것으로 입니다.</p><p>이를 해결하기 위해 Python은 일정 주기별로 스레드의 GIL을 강제로 릴리즈하는 메커니즘을 사용햇습니다. 다른 thread가 GIL을 획득하지 않으면 동일한 스레드가 계속 사용할 수 있습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="c1"># The interval is set to 100 instructions:
# sys.getcheckinterval()는 Python 3.7 기준으로 deprecated 되어 getswitchinterval()를 사용했습니다.
</span><span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">getswitchinterval</span><span class="p">())</span>
<span class="c1"># 0.005
</span></pre></table></code></div></div><p>이 메커니즘의 문제는 대부분의 경우 CPU 바운드 스레드가 다른 스레드가 GIL을 획득하기 전에 GIL 자체를 다시 획득한다는 것입니다.</p><p>이 문제는 삭제 된 다른 스레드의 GIL 획득 요청 수를 확인하고 다른 스레드가 실행되기 전에 현재 스레드가 GIL을 다시 획득하지 못하도록 하는 메커니즘을 추가한 Python 3.2에서 수정되었습니다.</p><h2 id="python의-gil을-다루는-방법">Python의 GIL을 다루는 방법</h2><p>GIL 때문에 성능 이슈 일으키는 경우 다음과 같은 방법을 시도할 수 있습니다.</p><p>multi processing : 가장 널리 사용되는 방법은 스레드 대신 여러 프로세스를 사용하는 multi processing 접근 방식을 사용하는 것입니다. 각 Python 프로세스에는 자체 Python 인터프리터와 메모리 공간이 있으므로 GIL은 문제가되지 않습니다. Python에는 다음 <code class="language-plaintext highlighter-rouge">multiprocessing</code>과 같은 프로세스를 쉽게 만들 수 있는 모듈이 있습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">COUNT</span> <span class="o">=</span> <span class="mi">50000000</span>


<span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>


<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">r1</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">countdown</span><span class="p">,</span> <span class="p">[</span><span class="n">COUNT</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="p">])</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">countdown</span><span class="p">,</span> <span class="p">[</span><span class="n">COUNT</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="p">])</span>

<span class="n">pool</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pool</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Time taken in seconds -'</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<span class="c1"># Time taken in seconds - 1.3406448364257812
</span></pre></table></code></div></div><p>멀티 스레드 버전에 비해 비약적으로 성능이 상당히 향상되지는 않았습니다. Python GIL은 어려운 주제로 간주됩니다. 그러나 C 확장을 작성하거나 프로그램에서 CPU 바인딩 된 멀티 스레딩을 사용하는 경우에만 영향을 받습니다.</p><blockquote><p>아마 프로세스 <code class="language-plaintext highlighter-rouge">context switching</code> 등의 오버헤드가 있기 때문일 것 같습니다. 또한 메모리 동기화 등에 좀 더 신경써야해서 더욱 어렵습니다. 다른 방법으로는 전에 포스팅했던 <code class="language-plaintext highlighter-rouge">asyncio</code>, <code class="language-plaintext highlighter-rouge">celery</code>등도 하나의 해결방법 입니다.</p></blockquote><h3 id="참조-링크">참조 링크</h3><ul><li><a href="https://wiki.python.org/moin/GlobalInterpreterLock">GlobalInterpreterLock - Python Wiki</a><li><a href="https://m.blog.naver.com/PostView.nhn?blogId=parkjy76&amp;logNo=30167429369&amp;proxyReferer=https%3A%2F%2Fwww.google.com%2F">파이썬 New GIL을 이해하기 : 네이버 블로그</a><li><a href="https://dgkim5360.tistory.com/entry/understanding-the-global-interpreter-lock-of-cpython">왜 Python에는 GIL이 있는가 :: 개발새발로그</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>programming</a>, <a href='/categories/python/'>python</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/concurrency/" class="post-tag no-text-decoration" >concurrency</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Python의 GIL - 잡잡 블로그&url=https://kimeuichan.github.io/posts/python-gil/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Python의 GIL - 잡잡 블로그&u=https://kimeuichan.github.io/posts/python-gil/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Python의 GIL - 잡잡 블로그&url=https://kimeuichan.github.io/posts/python-gil/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/deploy-docker-more-faster/">자주 변경되는 도커 이미지 빠르게 배포하기 (feat. 이미지 사이즈)</a><li><a href="/posts/python-asyncio/">Python에서 asyncio의 동작</a><li><a href="/posts/python-logging-with-loguru/">loguru를 사용하여 python 로깅 쉽게하기</a><li><a href="/posts/asnycio-with-blocing-task/">Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/asyncio/">asyncio</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/async/">async</a> <a class="post-tag" href="/tags/celery/">celery</a> <a class="post-tag" href="/tags/parallel/">parallel</a> <a class="post-tag" href="/tags/rabbitmq/">rabbitmq</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/python-asyncio/"><div class="card-body"> <span class="timeago small" > Nov 9, 2020 <i class="unloaded">2020-11-09T06:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python에서 asyncio의 동작</h3><div class="text-muted small"><p> python - How does asyncio actually work? - Stack Overflow 해당글을 번역한 글입니다. 파이썬에서 asnyc는 coroutine을 기반으로 동작합니다. coroutine의 동작을 이해하기 전 generator의 개념을 알고가면 이해하기 쉽기 때문에 먼저 generator 개념 부터 설명하겠습니다. Gen...</p></div></div></a></div><div class="card"> <a href="/posts/asnycio-with-blocing-task/"><div class="card-body"> <span class="timeago small" > Dec 11, 2020 <i class="unloaded">2020-12-11T00:45:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Asyncio에서 동기 라이브러리 사용하기(feat.태스크와 코루틴)</h3><div class="text-muted small"><p> 회사에서 많은 양의 API를 처리해야하는 서버를 구축해야하는 경우가 생겼습니다. 프로젝트 셋업에 있어 빠른 처리를 위해 Sanic 프레임워크를 사용하기로 했습니다. 다만, celery를 호출해야하는 경우가 생겨 asyncio와 호환성을 찾다가 결국 발견하지 못해 asyncio를 이용한 해결방안을 포스팅합니다. 찾아본 방법 celery 자체에...</p></div></div></a></div><div class="card"> <a href="/posts/python-celery/"><div class="card-body"> <span class="timeago small" > Nov 15, 2020 <i class="unloaded">2020-11-15T06:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python Celery란</h3><div class="text-muted small"><p> 해당 글은 celery를 이용하여 코드를 잘 작성하는것에 비중을 둔 글이 아니라 간단한 celery 소개 및 특징과 broker에 대해 공부하기 위해 작성한 글입니다. Celery는 python 동시성 프로그래밍에서 가장 많이 사용되는 방법 중 하나입니다. 몇 가지 설정만 한다면 간단하게 python 코드를 실행하는 worker를 만들 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/python-celery/" class="btn btn-outline-primary"><p>Python Celery란</p></a> <a href="/posts/python-interpreter/" class="btn btn-outline-primary"><p>Python Interpreter</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/kimeuichan">Euichan Kim</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/asyncio/">asyncio</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/async/">async</a> <a class="post-tag" href="/tags/celery/">celery</a> <a class="post-tag" href="/tags/parallel/">parallel</a> <a class="post-tag" href="/tags/rabbitmq/">rabbitmq</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://kimeuichan.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); </script>
